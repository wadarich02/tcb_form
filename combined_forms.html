<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>TAMU Capital Berhad - Compiled Forms</title>
    <style>
        /* General Style for Printing */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #EEE;
        }

        .form-page {
            width: 100%;
            max-width: 850px;
            margin: 20px auto;
            padding: 20px;
            box-sizing: border-box;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .page-break-before {
            page-break-before: always;
            margin-top: 40px;
        }

        @media print {

            body,
            .form-page {
                margin: 0;
                padding: 10px;
                box-shadow: none;
                background-color: white;
            }

            .page-break-before {
                page-break-before: always;
                margin-top: 0;
            }
        }

        /* Styles from 2_Application_Form_Green.html */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .logo-container {
            width: 30%;
        }

        .logo {
            width: 150px;
        }

        .address-container {
            text-align: center;
            width: 40%;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .program-container {
            width: 30%;
            text-align: right;
            font-size: 0.9em;
        }

        .program-box {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 2px solid #333;
            vertical-align: middle;
            margin-left: 5px;
            text-align: center;
            line-height: 22px;
            font-weight: bold;
        }

        .form-title {
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            margin: 20px 0;
            padding: 8px;
            background-color: #006400;
            color: white;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .section {
            margin-bottom: 15px;
        }

        .section-title {
            font-weight: bold;
            padding: 8px;
            background-color: #006400;
            color: white;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            font-size: 1em;
        }

        .form-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            flex-wrap: nowrap;
            gap: 5px;
        }

        .form-label {
            width: 140px;
            font-size: 0.85em;
            padding-right: 10px;
            line-height: 1.3;
            flex-shrink: 0;
        }

        .form-field {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
        }

        .char-box {
            display: inline-block;
            width: 20px;
            height: 26px;
            border: 1px solid #999;
            margin-right: 1px;
            vertical-align: middle;
            text-align: center;
            line-height: 26px;
            font-weight: bold;
            font-size: 0.8em;
        }

        .char-box-grid {
            display: flex;
            flex-wrap: nowrap;
            min-height: 28px;
            width: 100%;
        }

        .checkbox-option {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            font-size: 0.9em;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            border: 1px solid #999;
            margin-right: 8px;
            text-align: center;
            line-height: 18px;
            font-weight: bold;
        }

        .underline {
            border-bottom: 1px solid #333;
            display: inline-block;
            min-width: 150px;
            height: 1.2em;
            vertical-align: bottom;
            font-weight: bold;
            padding: 0 5px;
        }

        .signature-line {
            border-bottom: 1px dotted #333;
            height: 70px;
            margin-bottom: 10px;
            position: relative;
        }

        .signature-image {
            max-width: 200px;
            max-height: 50px;
            position: absolute;
            bottom: 5px;
            left: 25px;
        }

        .d-flex {
            display: flex;
        }

        /* Styles from 3_Buyer_Declaration.html */
        .buyer-declaration .title {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 30px;
            text-decoration: underline;
        }

        .buyer-declaration .signatures {
            display: flex;
            justify-content: space-around;
            margin-top: 50px;
            flex-wrap: wrap;
        }

        .buyer-declaration .signature-block {
            width: 30%;
            min-width: 200px;
            margin-top: 20px;
            text-align: center;
        }

        .buyer-declaration .signature-block p {
            margin: 8px 0;
            font-size: 0.9em;
        }

        .buyer-declaration .info-data {
            font-weight: bold;
        }

        /* Styles from 4_AMLA_NEW.html */
        .amla-form h1 {
            font-size: 1.2em;
            margin: 15px 0;
            text-transform: uppercase;
            text-align: center;
        }

        .amla-form .form-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ccc;
        }

        .amla-form .form-table td {
            padding: 8px 4px;
            vertical-align: top;
            border: 1px solid #ccc;
        }

        .amla-form .form-table td:first-child {
            width: 35%;
            font-weight: bold;
        }

        .amla-form .data-field {
            width: 100%;
            min-height: 24px;
            background: #f9f9f9;
            padding: 4px;
        }

        .amla-form .signature-section {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .amla-form .office-use-section {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 40px;
        }

        .amla-form legend {
            padding: 0 10px;
            font-weight: bold;
        }

        .amla-form .office-use-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 40px;
        }

        .amla-form .line-input {
            border: none;
            border-bottom: 1px solid #333;
            width: 100%;
            padding: 5px 0;
            min-height: 24px;
        }

        .amla-form .sig-line {
            height: 50px;
            border-bottom: 1px solid #333;
            position: relative;
        }

        /* Styles from 5_Profit_Distribution.html */
        .profit-form h1 {
            font-size: 1.5em;
            margin: 15px 0;
            text-transform: uppercase;
            text-align: center;
        }

        .profit-form .details-section {
            border: 2px solid #555;
            padding: 10px;
            margin-bottom: 30px;
        }

        .profit-form .details-section h2 {
            text-align: center;
            background-color: #e0e0e0;
            margin: -10px -10px 15px -10px;
            padding: 8px;
            font-size: 1.1em;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .profit-form .details-table {
            width: 100%;
            border-collapse: collapse;
        }

        .profit-form .details-table td {
            padding: 8px 5px;
        }

        .profit-form .details-table td:first-child {
            width: 30%;
            font-weight: bold;
        }

        .profit-form .data-field {
            width: 100%;
            min-height: 24px;
            background: #f9f9f9;
            padding: 4px;
            border-bottom: 1px solid #ccc;
        }

        .profit-form .signature-section {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .profit-form .request-text {
            margin: 20px 0;
            text-align: justify;
        }

        .profit-form .date-field {
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <div id="content1" class="form-page"></div>
    <div class="page-break-before"></div>
    <div id="content2" class="form-page buyer-declaration"></div>
    <div class="page-break-before"></div>
    <div id="content3" class="form-page amla-form"></div>
    <div class="page-break-before"></div>
    <div id="content4" class="form-page profit-form"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataString = localStorage.getItem('tamuPrintData');
            if (!dataString) { document.body.innerHTML = '<h1>Error: No data found. Please generate from the main form.</h1>'; return; }
            const data = JSON.parse(dataString);
            const filesToLoad = [
                { file: '2_Application_Form_Green.html', target: 'content1' },
                { file: '3_Buyer_Declaration.html', target: 'content2' },
                { file: '4_AMLA_NEW.html', target: 'content3' },
                { file: '5_Profit_Distribution.html', target: 'content4' }
            ];
            const fetchPromises = filesToLoad.map(item => fetch(item.file).then(res => res.text()).then(html => {
                document.getElementById(item.target).innerHTML = html.substring(html.indexOf('<body>') + 6, html.lastIndexOf('</body>'));
            }));

            Promise.all(fetchPromises)
                .then(() => {
                    populateGreenForm(data);
                    populateBuyerDeclaration(data);
                    populateAmlaForm(data);
                    populateProfitForm(data);
                    setTimeout(() => window.print(), 500);
                })
                .catch(error => { console.error('Error loading forms:', error); });
        });

        const formatDate = (dateString) => {
            if (!dateString || !moment(dateString).isValid()) return '';
            return moment(dateString).format('DD/MM/YYYY');
        };

        const setText = (id, value = '') => { const el = document.getElementById(id); if (el) el.textContent = value; };
        const setCheck = (id, checked) => { const el = document.getElementById(id); if (el && checked) { const cb = el.querySelector('.checkbox, .program-box'); if (cb) cb.textContent = '✓'; } };
        const setSignature = (id, url) => { const c = document.getElementById(id); if (c && url) c.innerHTML = `<img src="${url}" class="signature-image">`; };

        const fillCharBoxGrid = (containerId, text = '') => {
            const container = document.getElementById(containerId);
            if (!container) return;
            const availableWidth = container.offsetWidth;
            const boxWidth = 21; // width (20) + margin-right (1)
            const numBoxes = Math.floor(availableWidth / boxWidth);
            let html = '';
            const upperText = (text || '').toUpperCase();
            for (let i = 0; i < numBoxes; i++) {
                html += `<div class="char-box">${upperText[i] || ' '}</div>`;
            }
            container.innerHTML = html;
        };

        function populateGreenForm(data) {
            const { part1, part2, signatures } = data;
            const app = (part2.membershipApplicant.applicantType === "Guest's Partner") ? part1.partnerInfo : part1.guestInfo;
            const appBiz = (part2.membershipApplicant.applicantType === "Guest's Partner") ? part1.partnerBusiness : part1.guestBusiness;
            const nominee = part2.nominee.isPartner ? part1.partnerInfo : part2.nominee;
            const nomineeBiz = part2.nominee.isPartner ? part1.partnerBusiness : part2.nominee;

            // Page 1
            if (part2.salesDetail.productTypes.includes('Dirham')) setCheck('prodDirham', true);
            if (part2.salesDetail.productTypes.includes('Dinar')) setCheck('prodDinar', true);
            if (part2.salesDetail.productTypes.includes('Almas')) setCheck('prodAlmas', true);

            fillCharBoxGrid('appName', `${part2.membershipApplicant.title} ${app.fullName}`);
            fillCharBoxGrid('appNameOnCard', `${part2.membershipApplicant.title} ${part2.membershipApplicant.nameOnCard}`);
            fillCharBoxGrid('appNric', app.icPassport);
            fillCharBoxGrid('appDate', formatDate(signatures.applicant.date).replace(/\//g, ''));

            if (app.nationality?.toLowerCase().includes('malaysian')) setCheck('appNationalityMalaysian', true); else setCheck('appNationalityForeigner', true);
            if (app.maritalStatus === 'Single') setCheck('appMaritalSingle', true); else if (app.maritalStatus === 'Married') setCheck('appMaritalMarried', true);

            const homeAddress = `${app.correspondentAddress}, ${app.city}`.split(',');
            fillCharBoxGrid('appHomeAddress', homeAddress[0]);
            fillCharBoxGrid('appHomeAddress2', homeAddress.slice(1).join(', '));
            fillCharBoxGrid('appHomePostcode', app.poskod);

            const mailAddr = part1.guestInfo.mailingSameAsCorrespondent ? homeAddress.join(', ') : `${part1.guestInfo.mailingAddress}, ${part1.guestInfo.mailingCity}`;
            const mailAddrParts = mailAddr.split(',');
            fillCharBoxGrid('appMailingAddress', mailAddrParts[0]);
            fillCharBoxGrid('appMailingAddress2', mailAddrParts.slice(1).join(', '));

            fillCharBoxGrid('appHomePhone', ''); // No data for this
            fillCharBoxGrid('appFax', part2.applicantOffice.fax);
            fillCharBoxGrid('appHp', app.phone);
            setText('appEmail', app.email);
            setText('appOccupation', appBiz.occupation);

            const income = parseFloat((appBiz.monthlyIncome || "0").replace(/[^0-9-]/g, '').split('-')[0]) * 12;
            if (income > 60000) setCheck('appIncome4', true); else if (income >= 36000) setCheck('appIncome3', true); else if (income >= 24000) setCheck('appIncome2', true); else if (income > 0) setCheck('appIncome1', true);

            fillCharBoxGrid('appEmployer', appBiz.industry);
            setText('appIndustry', appBiz.industry);
            const officeAddr = `${part2.applicantOffice.address}, ${part2.applicantOffice.city}`.split(',');
            fillCharBoxGrid('appOfficeAddress', officeAddr[0]);
            fillCharBoxGrid('appOfficeAddress2', officeAddr.slice(1).join(', '));
            fillCharBoxGrid('appOfficePostcode', part2.applicantOffice.poskod);
            fillCharBoxGrid('appOfficePhone', part2.applicantOffice.tel);
            fillCharBoxGrid('appOfficeExt', ''); // No data for this
            fillCharBoxGrid('appOfficeFax', part2.applicantOffice.fax);

            // Page 2
            fillCharBoxGrid('nomineeName', nominee.fullName);
            fillCharBoxGrid('nomineeNric', nominee.icPassport);
            setText('nomineeEmail', ''); // No data for this
            if (nominee.nationality?.toLowerCase().includes('malaysian')) setCheck('nomineeNationalityMalaysian', true); else { setCheck('nomineeNationalityForeigner', true); setText('nomineeNationalityForeignerText', nominee.nationality); }
            fillCharBoxGrid('nomineeRelation', nominee.relationshipToGuest || nominee.relationship);
            fillCharBoxGrid('nomineeEmployer', nomineeBiz.occupation);
            fillCharBoxGrid('nomineeHp', nominee.phone);

            setText('declarationDate', formatDate(signatures.applicant.date));
            setSignature('applicantSignature', signatures.applicant.signatureData);

            fillCharBoxGrid('programId', part1.officeUse.tmCode);
            setText('programsFee', part2.salesDetail.totalAmount);
            setText('balance', '0.00'); // No data for this
            if (part2.salesDetail.transactionMethod === 'Debit/Credit/Cash/Cheque') setCheck('paymentCash', true);
            else if (part2.salesDetail.transactionMethod === 'In-House') setCheck('paymentInstalment', true); // Assuming
            else if (part2.salesDetail.transactionMethod === 'Loan') setCheck('paymentLoan', true); // Assuming
            setText('counsellor', part1.officeUse.consultant);
            setText('checkBy', signatures.witness.name);
            setText('checkByDate', formatDate(signatures.witness.date));
        }

        function populateBuyerDeclaration(data) {
            const sigs = data.signatures;
            const setText = (id, value) => { const el = document.getElementById(id); if (el && value) el.textContent = value; };
            const setSignature = (id, url) => { const c = document.getElementById(id); if (c && url) c.innerHTML = `<img src="${url}" class="signature-image">`; };
            if (sigs.applicant) { setSignature('applicantSignatureLine', sigs.applicant.signatureData); setText('applicantName', sigs.applicant.name); setText('applicantId', sigs.applicant.ic); setText('applicantDate', sigs.applicant.date); }
            if (sigs.nominee) { setSignature('jointApplicantSignatureLine', sigs.nominee.signatureData); setText('jointApplicantName', sigs.nominee.name); setText('jointApplicantId', sigs.nominee.ic); setText('jointApplicantDate', sigs.nominee.date); }
            if (sigs.witness) { setSignature('witnessSignatureLine', sigs.witness.signatureData); setText('witnessName', sigs.witness.name); setText('witnessId', sigs.witness.ic); setText('witnessDate', sigs.witness.date); }
        }

        function populateAmlaForm(data) {
            const p1 = data.part1, p2 = data.part2, sigs = data.signatures;
            const setVal = (id, value) => { const el = document.getElementById(id); if (el) el.value = value || ''; };
            const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value || ''; };
            const setSig = (id, url) => { const el = document.getElementById(id); if (el && url) el.innerHTML = `<img src="${url}" style="max-height:50px; position:absolute; bottom:5px; left:10px;">`; };
            let app = (p2.membershipApplicant.applicantType === "Guest's Partner") ? p1.partnerInfo : p1.guestInfo;
            let appBiz = (p2.membershipApplicant.applicantType === "Guest's Partner") ? p1.partnerBusiness : p1.guestBusiness;
            let mailAddr = app.mailingSameAsCorrespondent ? `${app.correspondentAddress}, ${app.poskod} ${app.city}` : `${app.mailingAddress}, ${app.mailingPoskod} ${app.mailingCity}`;
            setVal('amlaName', app.fullName); setVal('amlaNric', app.icPassport);
            setVal('amlaHomeAddress', `${app.correspondentAddress}, ${app.poskod} ${app.city}`);
            setVal('amlaMailingAddress', mailAddr);
            setVal('amlaMobile', app.phone); setVal('amlaEmail', app.email); setVal('amlaOccupation', appBiz.occupation);
            if (sigs.applicant) { setSig('amlaSig', sigs.applicant.signatureData); setVal('amlaSigName', sigs.applicant.name); setVal('amlaSigDate', sigs.applicant.date); }
            const receiverNameEl = document.getElementById('receiver-name');
            if (receiverNameEl) receiverNameEl.textContent = sigs.consultant.name;
            setSig('receiver-sig', sigs.consultant.signatureData);
            const receiverDateEl = document.getElementById('receiver-date');
            if (receiverDateEl) receiverDateEl.textContent = sigs.consultant.date;
            const witnessNameEl = document.getElementById('witness-name');
            if (witnessNameEl) witnessNameEl.textContent = sigs.witness.name;
            setSig('witness-sig', sigs.witness.signatureData);
            const witnessDateEl = document.getElementById('witness-date');
            if (witnessDateEl) witnessDateEl.textContent = sigs.witness.date;
        }

        function populateProfitForm(data) {
            const p1 = data.part1, p2 = data.part2, sigs = data.signatures;
            const setVal = (id, value) => { const el = document.getElementById(id); if (el) el.value = value || ''; };
            const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value || ''; };
            const setSig = (id, url) => { const el = document.getElementById(id); if (el && url) el.innerHTML = `<img src="${url}" style="max-height:50px; position:absolute; bottom:5px; left:10px;">`; };
            let app = (p2.membershipApplicant.applicantType === "Guest's Partner") ? p1.partnerInfo : p1.guestInfo;
            setVal('pdName', app.fullName); setVal('pdNric', app.icPassport);
            setVal('pdAccountNo', p2.applicantBanking.accountNumber); setVal('pdBankName', p2.applicantBanking.bankName);
            setVal('pdPhone', app.phone); setVal('pdEmail', app.email);
            if (sigs.applicant) { setSig('pdPrincipalSig', sigs.applicant.signatureData); setText('pdPrincipalDate', sigs.applicant.date); }
            if (sigs.consultant) { setSig('pdManagerSig', sigs.consultant.signatureData); setText('pdManagerDate', sigs.consultant.date); }
        }
    </script>
</body>

</html>